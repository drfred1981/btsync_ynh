#!/bin/bash

# Retrieve arguments
domain=$1
path=$2
platform=$3

# Remove trailing "/" for next commands
path=${path%/}

# Check domain/path availability
sudo yunohost app checkurl $domain$path -a btsync
if [[ ! $? -eq 0 ]]; then
    exit 1
fi


sudo cp ../sources/$platform/btsync /usr/bin/
sudo mkdir /var/www/btsync/
sudo chown -R www-data:www-data /var/www/btsync/
sudo cp ../sources/index.php /var/www/btsync/

for i in $(ls /home)
do
	sudo yunohost user list --json | grep -q "\"username\": \"$i\""
	if [[ $? -eq 0 ]];
	then
		sudo mkdir /home/$i/.sync
		sudo cp ../conf/user.config.json /home/$i/.sync/config.json
		sed -i "s@DEVICENAME@$domain - $i@g" /home/$i/.sync/config.json
		sed -i "s@LOGINNAME@$i@g" /home/$i/.sync/config.json
			
	fi
done

sudo cp ../conf/init.btsync /etc/init.d/btsync
sudo chmod +x /etc/init.d/btsync


final_path=/var/www/btsync
sed -i "s@PATHTOCHANGE@$path@g" ../conf/nginx.conf
sed -i "s@ALIASTOCHANGE@$final_path/@g" ../conf/nginx.conf
sudo cp ../conf/nginx.conf /etc/nginx/conf.d/$domain.d/btsync.conf


# Reload Nginx and regenerate SSOwat conf
sudo service nginx reload
sudo yunohost app ssowatconf
